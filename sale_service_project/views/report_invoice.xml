<?xml version="1.0" encoding="utf-8"?>
<openerp>
<data>

<template id="report_invoice_document"
          inherit_id="account.report_invoice_document">
    <xpath expr="//span[@t-field='l.name']/../.." position="inside">
        <t t-if="o.print_works">
            <!--Invoice done directly from sale order-->
            <t t-if="not l.task_work_ids and not l.task_materials_ids">
                <t t-raw="'&lt;/tr&gt;&lt;tr class=\'works_title\'&gt;'"/>
                    <td class="works_lbl">Works</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td groups="sale.group_discount_per_so_line"></td>
                    <td></td>
                <t t-foreach="l.sale_order_lines" t-as="order_line">
                    <t t-set="pricelist_id" t-value="order_line.order_id.pricelist_id.id"/>
                    <t t-foreach="order_line.task_work_ids" t-as="work">
                        <t t-raw="'&lt;/tr&gt;&lt;tr class=\'invoice_works_line\'&gt;'"/>
                        <td class="works_line_name"><span t-field="work.name"/></td>
                        <td class="invoice_works_line_hours">
                            <span t-esc="formatLang(work.hours, dp='Product Unit of Measure')"/>
                            <span groups="product.group_uom" t-field="uom_hour.name"/>
                        </td>
                        <td class="works_line_price">
                            <t t-if="order_line.compute_price">
                                <t t-set="price_hours"
                                   t-value="order_line.order_id.pricelist_id.price_get(order_line.task_work_product_id.id, total_hours, partner_id)[pricelist_id]" />
                                <span t-esc="formatLang(price_hours, dp='Product Price')"/>
                            </t>
                        </td>
                        <td groups="sale.group_discount_per_so_line"></td>
                        <td></td>
                        <td></td>
                    </t>
                    <t t-raw="'&lt;/tr&gt;&lt;tr class=\'materials_title\'&gt;'"/>
                        <td class="materials_lbl">Materials</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td groups="sale.group_discount_per_so_line"></td>
                        <td></td>
                    <t t-foreach="order_line.task_materials_ids" t-as="material">
                        <t t-raw="'&lt;/tr&gt;&lt;tr class=\'invoice_materials_line\'&gt;'"/>
                        <td class="materials_line_name">
                            <span t-field="material.product_id.display_name"/>
                        </td>
                        <td class="invoice_materials_line_qty">
                            <span t-esc="formatLang(material.quantity, dp='Product Unit of Measure')"/>
                            <span groups="product.group_uom"
                                  t-field="material.product_id.uom_id.name"/>
                        </td>
                        <td class="materials_line_price">
                            <t t-if="order_line.compute_price">
                                <t t-set="price_material"
                                   t-value="order_line.order_id.pricelist_id.price_get(material.product_id.id, material.quantity, partner_id)[pricelist_id]" />
                                <span t-esc="formatLang(price_material, dp='Product Price')"/>
                            </t>
                        </td>
                        <td groups="sale.group_discount_per_so_line"></td>
                        <td></td>
                        <td></td>
                    </t>
                </t>
            </t>
            <!--Invoice done directly from project task-->
            <t t-if="l.task_work_ids or l.task_materials_ids">
                <t t-if="l.task_work_ids">
                    <t t-raw="'&lt;/tr&gt;&lt;tr class=\'works_title\'&gt;'"/>
                        <td class="works_lbl">Works</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td groups="sale.group_discount_per_so_line"></td>
                        <td></td>
                    <t t-foreach="l.task_work_ids" t-as="work">
                        <t t-raw="'&lt;/tr&gt;&lt;tr class=\'invoice_works_line\'&gt;'"/>
                        <td class="works_line_name"><span t-field="work.name"/></td>
                        <td class="invoice_works_line_hours">
                            <span t-esc="formatLang(work.hours, dp='Product Unit of Measure')"/>
                            <span groups="product.group_uom" t-field="uom_hour.name"/>
                        </td>
                        <td></td>
                        <td groups="sale.group_discount_per_so_line"></td>
                        <td></td>
                        <td></td>
                    </t>
                </t>
            </t>
        </t>
    </xpath>

    <xpath expr="//span[@t-field='l.name']" position="replace">
        <t t-if="o.print_works">
            <t t-if="l.product_id.type!='service'">
                <span t-field="l.name"/>
            </t>
            <t t-if="l.product_id.type=='service'">
                <t t-if="not (l.task_work_ids or l.task_materials_ids)">
                    <span t-field="l.name"/>
                </t>
                <t t-if="l.task_work_ids or l.task_materials_ids">
                    <t t-set="task"
                       t-value="l.task_work_ids.mapped('task_id') | l.task_materials_ids.mapped('task_id')"/>
                    <span t-field="task.name"/>
                </t>
            </t>
        </t>
    </xpath>
</template>

</data>
</openerp>
