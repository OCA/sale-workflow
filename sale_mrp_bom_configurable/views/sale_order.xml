<?xml version="1.0" encoding="utf-8" ?>
<odoo>
<record id="sale_order_view_search_inherit_quotation" model="ir.ui.view">
    <field name="model">sale.order</field>
    <field name="name">sale.order.configurable.search</field>
    <field name="inherit_id" ref="sale.sale_order_view_search_inherit_quotation" />
    <field name="arch" type="xml">
        <filter name="my_quotation" position="attributes">
            <attribute
                    name="domain"
                >[('user_id', '=', uid),('input_config_id', '=', False)]</attribute>
        </filter>
        <filter name="my_quotation" position="before">
            <filter
                    string="My configurable quotations"
                    name="my_quotation_configurable"
                    domain="[('user_id', '=', uid), ('input_config_id', '!=', False)]"
                />
        </filter>
    </field>
</record>
<record id="view_order_form_configurable" model="ir.ui.view">
    <field name="name">sale.order.form.configurable</field>
    <field name="model">sale.order</field>
    <field
            name="priority"
        >20</field> <!-- we use priority 20 because default sale.order.form priority is 16 and we want to be higher than that -->
    <field name="inherit_id" ref="sale.view_order_form" />
    <field name="mode">primary</field>
    <field name="arch" type="xml">
        <group name="sale_header" position="inside">
            <group name="input_config_selection">
                <field name="input_config_id" invisible="1" />
                <field
                        name="bom_id"
                        domain="[('configuration_type', '=', 'variable')]"
                        required="True"
                    />
            </group>
        </group>
        <xpath
                expr="//page[@name='order_lines']//tree/field[@name='product_template_id']"
                position="before"
            >
            <field name="allowed_product_id" invisible="1" />
            <field name="should_not_filter_product" invisible="1" />
        </xpath>
        <xpath
                expr="//page[@name='order_lines']//tree/field[@name='product_template_id']"
                position="attributes"
            >
            <attribute
                    name="domain"
                >['|', ('sale_ok', '=', should_not_filter_product), ('id', '=', allowed_product_id)]</attribute>
        </xpath>
        <xpath expr="//field[@name='order_line']" position="attributes">
            <attribute name="context">{'input_config_id': input_config_id}</attribute>
        </xpath>
        <xpath
                expr="//page[@name='order_lines']//tree/field[@name='product_template_id']"
                position="after"
            >
            <button
                    name="action_show_input_line"
                    class="fa fa-gear"
                    type="object"
                    title="Info"
                    attrs="{'invisible': [('input_line_id', '=', False)]}"
                />
            <button
                    name="action_run_copy_data_wizard"
                    class="fa fa-paste"
                    type="object"
                    title="Info"
                    attrs="{'invisible': [('input_line_id', '=', False)]}"
                />
            <field name="input_config_id" invisible="1" />
            <field name="input_line_id" invisible="1" />
            <field name="input_line_id_name" />
        </xpath>
    </field>
</record>
<record id="action_create_quotations_configurable" model="ir.actions.act_window">
    <field name="name">Configurable quotation</field>
    <field name="type">ir.actions.act_window</field>
    <field name="view_id" ref="view_order_form_configurable" />
    <field name="search_view_id" ref="sale_order_view_search_inherit_quotation" />
    <field name="res_model">sale.order</field>
    <field name="view_mode">form</field>
    <field name="context">{'configurable_quotation': 1}</field>
</record>
<record id="action_quotations_configurable" model="ir.actions.act_window">
    <field name="name">Configurable quotation</field>
    <field name="type">ir.actions.act_window</field>
    <field name="res_model">sale.order</field>
    <field name="view_mode">tree,kanban,form,calendar,pivot,graph,activity</field>
    <field name="search_view_id" ref="sale_order_view_search_inherit_quotation" />
    <field
            name="context"
        >{'search_default_my_quotation_configurable': 1, 'configurable_quotation': 1}</field>
</record>
<record
        model="ir.actions.act_window.view"
        id="action_quotations_configurable_view_tree"
    >
    <field name="act_window_id" ref="action_quotations_configurable" />
    <field name="sequence" eval="10" />
    <field name="view_mode">tree</field>
    <field name="view_id" ref="sale.view_quotation_tree" />
</record>
<record
        model="ir.actions.act_window.view"
        id="action_quotations_configurable_view_form"
    >
    <field name="act_window_id" ref="action_quotations_configurable" />
    <field name="sequence" eval="20" />
    <field name="view_mode">form</field>
    <field name="view_id" ref="view_order_form_configurable" />
</record>
<menuitem
        id="menu_sale_quotations_configurable"
        name="Configurable quotation"
        action="action_quotations_configurable"
        parent="sale.sale_order_menu"
        groups="sales_team.group_sale_salesman"
        sequence="5"
    />
</odoo>
